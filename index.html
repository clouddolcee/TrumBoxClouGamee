<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Game PC - Thuê Trên Điện Thoại</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 100%);
            color: #e0e0e0;
            line-height: 1.6;
            position: relative;
            overflow-x: hidden;
        }
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
        }
        header {
            background: linear-gradient(90deg, #FFD700 0%, #1a1a1a 100%);
            color: #fff;
            text-align: center;
            padding: 2rem 1rem;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
            position: relative;
            z-index: 1;
        }
        header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        header p {
            font-size: 0.9rem;
            font-weight: 300;
            opacity: 0.9;
        }
        nav {
            background: #0f0f0f;
            padding: 0.5rem 1rem;
            box-shadow: 0 2px 15px rgba(255, 215, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .hamburger {
            display: none;
            font-size: 1.5rem;
            color: #FFD700;
            cursor: pointer;
        }
        .menu {
            display: flex;
            gap: 1rem;
        }
        .menu a {
            color: #FFD700;
            text-decoration: none;
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.3s ease, text-shadow 0.3s ease;
            touch-action: manipulation;
        }
        .menu a:hover {
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        .wallet {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .wallet a {
            color: #FFD700;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            touch-action: manipulation;
        }
        .wallet a:hover {
            color: #fff;
        }
        .wallet .balance {
            color: #FFD700;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .wallet .user-info {
            color: #FFD700;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .wallet .logout {
            background: #FF4500;
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
            touch-action: manipulation;
        }
        .wallet .logout:hover {
            background: #FF6347;
        }
        .container {
            max-width: 100%;
            margin: 1rem auto;
            padding: 0 0.5rem;
        }
        .section {
            background: rgba(30, 30, 30, 0.9);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.1);
            animation: fadeInUp 0.8s ease-out;
        }
        .section h2 {
            font-family: 'Montserrat', sans-serif;
            color: #FFD700;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
        }
        .section label {
            display: block;
            margin: 0.5rem 0 0.2rem;
            color: #FFD700;
            font-size: 0.9rem;
        }
        .section input {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border: 1px solid #FFD700;
            border-radius: 8px;
            background: #2c2c2c;
            color: #e0e0e0;
            font-size: 1rem;
            touch-action: manipulation;
        }
        .section button {
            background: #FFD700;
            color: #1a1a1a;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0;
            transition: background 0.3s ease;
            touch-action: manipulation;
        }
        .section button:hover {
            background: #e6c200;
        }
        .section a.support-link {
            display: inline-block;
            background: #0088cc;
            color: #fff;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            text-decoration: none;
            font-size: 1rem;
            margin-top: 0.5rem;
            transition: background 0.3s ease;
            touch-action: manipulation;
        }
        .section a.support-link:hover {
            background: #00aaff;
        }
        .pricing {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .plan {
            background: rgba(40, 40, 40, 0.9);
            padding: 1.2rem;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #FFD700;
        }
        .plan.recommended {
            background: linear-gradient(135deg, #FFD700 0%, #1a1a1a 100%);
            border: 2px solid #FFD700;
        }
        .plan.recommended::before {
            content: 'Khuyến nghị';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #FFD700;
            color: #1a1a1a;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .plan h3 {
            font-family: 'Montserrat', sans-serif;
            color: #e0e0e0;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .plan.recommended h3 {
            color: #1a1a1a;
        }
        .plan .price {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.5rem;
            color: #FFD700;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        .plan.recommended .price {
            color: #1a1a1a;
        }
        .plan .subscribers {
            font-size: 0.8rem;
            color: #b0b0b0;
            margin: 0.3rem 0;
        }
        .plan p {
            font-size: 0.9rem;
            color: #d0d0d0;
            margin: 0.3rem 0;
        }
        .plan button {
            background: #FFD700;
            color: #1a1a1a;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            margin-top: 0.5rem;
            width: 100%;
            max-width: 200px;
            transition: background 0.3s ease, transform 0.2s ease;
            touch-action: manipulation;
        }
        .plan.recommended button {
            background: #1a1a1a;
            color: #FFD700;
        }
        .plan button:hover {
            background: #e6c200;
            transform: scale(1.05);
        }
        .plan.recommended button:hover {
            background: #2c2c2c;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #1e1e1e;
            padding: 1.5rem;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #FFD700;
            position: relative;
        }
        .modal-content h3 {
            font-family: 'Montserrat', sans-serif;
            color: #FFD700;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .modal-content .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #FFD700;
            touch-action: manipulation;
        }
        .modal-content .close:hover {
            color: #FF4500;
        }
        .modal-content label {
            display: block;
            margin: 0.5rem 0 0.2rem;
            font-weight: 500;
            color: #FFD700;
            text-align: left;
            font-size: 0.9rem;
        }
        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            border: 1px solid #FFD700;
            border-radius: 8px;
            font-size: 1rem;
            background: #2c2c2c;
            color: #e0e0e0;
            touch-action: manipulation;
        }
        .modal-content button {
            background: #FFD700;
            color: #1a1a1a;
            border: none;
            padding: 0.8rem;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            width: 100%;
            transition: background 0.3s ease;
            touch-action: manipulation;
        }
        .modal-content button:hover {
            background: #e6c200;
        }
        .modal-content img.qr-code {
            max-width: 150px;
            margin: 0.5rem auto;
            display: block;
            border-radius: 8px;
            border: 2px solid #FFD700;
        }
        .modal-content p {
            font-size: 0.9rem;
            color: #d0d0d0;
            margin: 0.3rem 0;
        }
        .modal-content p.note {
            font-size: 0.85rem;
            color: #FF4500;
            font-weight: 500;
            text-align: left;
        }
        .modal-content a {
            color: #FFD700;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            touch-action: manipulation;
        }
        .modal-content a:hover {
            color: #e6c200;
        }
        .modal-content .error,
        .modal-content .success {
            font-size: 0.9rem;
            margin: 0.5rem 0;
            display: none;
        }
        .modal-content .error {
            color: #FF4500;
        }
        .modal-content .success {
            color: #FFD700;
        }
        footer {
            background: #0f0f0f;
            color: #FFD700;
            text-align: center;
            padding: 1rem;
            width: 100%;
        }
        .loading-spinner {
            display: none;
            border: 4px solid #FFD700;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0.5rem auto;
        }
        .notification {
            background: rgba(255, 215, 0, 0.2);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border: 1px solid #FFD700;
            font-size: 0.9rem;
            color: #FFD700;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            header {
                padding: 1.5rem 0.5rem;
            }
            header h1 {
                font-size: 1.5rem;
            }
            header p {
                font-size: 0.8rem;
            }
            .hamburger {
                display: block;
            }
            .menu {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 50px;
                left: 0;
                background: #0f0f0f;
                width: 100%;
                padding: 1rem;
                box-shadow: 0 2px 10px rgba(255, 215, 0, 0.1);
            }
            .menu.active {
                display: flex;
            }
            .menu a {
                font-size: 1.1rem;
                padding: 0.5rem 0;
                display: block;
            }
            .wallet {
                gap: 0.3rem;
            }
            .wallet a, .wallet .balance, .wallet .user-info {
                font-size: 0.8rem;
            }
            .wallet .logout {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
            }
            .section {
                padding: 1rem;
                margin-bottom: 0.8rem;
            }
            .section h2 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }
            .section p {
                font-size: 0.9rem;
            }
            .plan {
                padding: 1rem;
            }
            .plan h3 {
                font-size: 1.1rem;
            }
            .plan .price {
                font-size: 1.3rem;
            }
            .plan .subscribers {
                font-size: 0.7rem;
            }
            .plan p {
                font-size: 0.8rem;
            }
            .plan button {
                padding: 0.7rem;
                font-size: 0.9rem;
                max-width: 180px;
            }
            .modal-content {
                padding: 1rem;
                max-width: 90%;
            }
            .modal-content h3 {
                font-size: 1.3rem;
            }
            .modal-content label {
                font-size: 0.8rem;
            }
            .modal-content input,
            .modal-content select {
                padding: 0.6rem;
                font-size: 0.9rem;
            }
            .modal-content button {
                padding: 0.7rem;
                font-size: 0.9rem;
            }
            .modal-content img.qr-code {
                max-width: 120px;
            }
            .modal-content p.note {
                font-size: 0.8rem;
            }
            footer {
                padding: 0.8rem;
                font-size: 0.8rem;
            }
            .notification {
                padding: 0.8rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <header>
        <h1>Cloud Game PC</h1>
        <p>Chơi game mượt mà trên mọi thiết bị!</p>
    </header>
    <nav>
        <div class="nav-container">
            <div class="hamburger">☰</div>
            <div class="menu">
                <a href="#home">Trang Chủ</a>
                <a href="#pricing">Gói Dịch Vụ</a>
                <a href="#code">Nhập Code</a>
                <a href="#support">Hỗ Trợ</a>
                <a href="#about">Về Chúng Tôi</a>
                <a href="#contact">Liên Hệ</a>
            </div>
            <div class="wallet">
                <span class="balance">Số dư: 0 VNĐ</span>
                <a href="#" id="topupLink">Nạp Tiền</a>
                <div id="authLinks">
                    <a href="#" id="loginLink">Đăng Nhập</a>
                    <a href="#" id="registerLink">Đăng Ký</a>
                </div>
                <div id="userInfo" style="display: none;">
                    <span class="user-info" id="userDetails"></span>
                    <button class="logout" id="logoutButton">Đăng Xuất</button>
                </div>
            </div>
        </div>
    </nav>
    <div class="container">
        <div id="notificationArea"></div>
        <div class="section" id="home">
            <h2>Chào Mừng</h2>
            <p>Chơi game PC yêu thích trên điện thoại với kết nối internet. Không cần cấu hình mạnh!</p>
        </div>
        <div class="section" id="pricing">
            <h2>Gói Dịch Vụ</h2>
            <div class="pricing">
                <div class="plan recommended" id="trumboxPlan">
                    <h3>Thuê Máy Trumbox</h3>
                    <p class="price">3.000 VNĐ/giờ</p>
                    <p class="subscribers">1,234 người thuê</p>
                    <p>Chơi không giới hạn game.</p>
                    <p>Hỗ trợ trên mọi thiết bị.</p>
                    <p>Băng thông ổn định, độ trễ thấp.</p>
                    <button onclick="rentTrumbox(event)">Thuê Ngay</button>
                    <div class="loading-spinner" id="trumboxSpinner"></div>
                </div>
                <div class="plan" id="premiumPlan">
                    <h3>Gói Nâng Cao</h3>
                    <p class="price">350.000 VNĐ/Vĩnh Viễn</p>
                    <p class="subscribers">567 người thuê</p>
                    <p>Truy cập toàn bộ game.</p>
                    <p>Hỗ trợ độ phân giải 4K.</p>
                    <p>Máy chủ VIP.</p>
                    <button onclick="purchasePlan('Gói Nâng Cao', 350000, event)">Mua Gói</button>
                    <div class="loading-spinner" id="premiumSpinner"></div>
                </div>
            </div>
        </div>
        <div class="section" id="code">
            <h2>Nhập Code</h2>
            <p>Nhập mã code để nhận thưởng từ 5.000 VNĐ đến 500.000 VNĐ!</p>
            <label for="redeemCode">Mã Code</label>
            <input type="text" id="redeemCode" placeholder="VD: CODE15K01">
            <button onclick="redeemCode()">Nhập Code</button>
            <div class="loading-spinner" id="codeSpinner"></div>
            <p class="success" id="codeSuccess" style="display: none;">Nhập code thành công!</p>
            <p class="error" id="codeError" style="display: none;"></p>
        </div>
        <div class="section" id="support">
            <h2>Hỗ Trợ</h2>
            <p>Liên hệ với chúng tôi qua Telegram để được hỗ trợ nhanh chóng!</p>
            <a href="https://t.me/limorecloudgame" class="support-link" target="_blank">Chat với @limorecloudgame</a>
        </div>
        <div class="section" id="about">
            <h2>Về Chúng Tôi</h2>
            <p>Dịch vụ Cloud Gaming hàng đầu tại Việt Nam, chơi game mọi lúc, mọi nơi.</p>
        </div>
        <div class="section" id="contact">
            <h2>Liên Hệ</h2>
        </div>
    </div>
    <!-- Modals -->
    <div class="modal" id="topupModal">
        <div class="modal-content">
            <span class="close" id="closeTopupModal">×</span>
            <h3>Nạp Tiền</h3>
            <form id="topupForm">
                <label for="paymentMethod">Phương Thức Thanh Toán</label>
                <select id="paymentMethod" name="paymentMethod" onchange="toggleForm()">
                    <option value="bank">Ngân Hàng VietinBank</option>
                    <option value="card">Thẻ Cào</option>
                </select>
                <div id="bankForm">
                    <p>Quét mã QR để chuyển khoản.</p>
                    <img src="https://i.imgur.com/4mmpR89.png" alt="QR Code VietinBank" class="qr-code">
                    <p class="note">Lưu ý: Số tiền nạp tối thiểu 15.000 VNĐ. Các giao dịch dưới 15.000 VNĐ sẽ không được cộng tiền.</p>
                    <p class="note">Lưu ý: Phần ghi chú khi chuyển khoản phải ghi ID tài khoản của bạn trên website (VD: 123456).</p>
                </div>
                <div id="cardForm" style="display: none;">
                    <p>Nhập mã thẻ và serial.</p>
                    <p>Tối thiểu: 10.000đ</p>
                    <label for="cardProvider">Nhà Mạng</label>
                    <select id="cardProvider" name="cardProvider">
                        <option value="viettel">Viettel</option>
                        <option value="mobifone">Mobifone</option>
                        <option value="vinaphone">Vinaphone</option>
                    </select>
                    <label for="cardAmount">Mệnh Giá (VNĐ)</label>
                    <select id="cardAmount" name="cardAmount">
                        <option value="10000">10.000</option>
                        <option value="20000">20.000</option>
                        <option value="50000">50.000</option>
                        <option value="100000">100.000</option>
                    </select>
                    <label for="cardCode">Mã Thẻ</label>
                    <input type="text" id="cardCode" name="cardCode" placeholder="Mã thẻ" required>
                    <label for="cardSerial">Số Serial</label>
                    <input type="text" id="cardSerial" name="cardSerial" placeholder="Số serial" required>
                </div>
                <button type="submit">Gửi Yêu Cầu</button>
                <div class="loading-spinner" id="topupSpinner"></div>
                <p class="success" id="topupSuccess" style="display: none;">Yêu cầu đã gửi!</p>
                <p class="error" id="topupError" style="display: none;"></p>
            </form>
        </div>
    </div>
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close" id="closeLoginModal">×</span>
            <h3>Đăng Nhập</h3>
            <form id="loginForm">
                <p class="error" id="loginError" style="display: none;"></p>
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" name="loginEmail" placeholder="Email" required>
                <label for="loginPassword">Mật Khẩu</label>
                <input type="password" id="loginPassword" name="loginPassword" placeholder="Mật khẩu" required>
                <button type="submit">Đăng Nhập</button>
                <div class="loading-spinner" id="loginSpinner"></div>
                <p>Chưa có tài khoản? <a href="#" id="showRegister">Đăng Ký</a></p>
            </form>
        </div>
    </div>
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close" id="closeRegisterModal">×</span>
            <h3>Đăng Ký</h3>
            <form id="registerForm">
                <p class="error" id="registerError" style="display: none;"></p>
                <p class="success" id="registerSuccess" style="display: none;">Đăng ký thành công!</p>
                <label for="registerUsername">Tên Người Dùng</label>
                <input type="text" id="registerUsername" name="registerUsername" placeholder="Tên người dùng" required>
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" name="registerEmail" placeholder="Email" required>
                <label for="registerPassword">Mật Khẩu</label>
                <input type="password" id="registerPassword" name="registerPassword" placeholder="Mật khẩu" required>
                <label for="confirmPassword">Xác Nhận Mật Khẩu</label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Xác nhận mật khẩu" required>
                <button type="submit" id="registerButton">Đăng Ký</button>
                <div class="loading-spinner" id="registerSpinner"></div>
                <p>Đã có tài khoản? <a href="#" id="showLogin">Đăng Nhập</a></p>
            </form>
        </div>
    </div>
    <footer>
        <p>© 2025 Cloud Game PC.</p>
    </footer>
    <script>
        // Particles.js Configuration
        const isMobile = window.innerWidth <= 768;
        if (typeof particlesJS !== 'undefined') {
            try {
                particlesJS('particles-js', {
                    particles: {
                        number: { value: isMobile ? 20 : 50, density: { enable: true, value_area: 800 } },
                        color: { value: '#FFD700' },
                        shape: { type: 'circle' },
                        opacity: { value: 0.5, random: true },
                        size: { value: 3, random: true },
                        line_linked: { enable: true, distance: 150, color: '#FFD700', opacity: 0.4, width: 1 },
                        move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
                    },
                    interactivity: {
                        detect_on: 'canvas',
                        events: { onhover: { enable: !isMobile, mode: 'repulse' }, onclick: { enable: !isMobile, mode: 'push' }, resize: true },
                        modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
                    },
                    retina_detect: true
                });
            } catch (error) {
                console.error('Lỗi khi khởi tạo Particles.js:', error);
            }
        } else {
            console.warn('Particles.js không tải được, bỏ qua hiệu ứng hạt.');
        }

        // Utility: Hash Password (SHA-256)
        async function hashPassword(password) {
            try {
                const msgBuffer = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            } catch (error) {
                console.error('Lỗi khi mã hóa mật khẩu:', error);
                throw new Error('Không thể mã hóa mật khẩu.');
            }
        }

        // Utility: Generate Numeric Player ID
        function generatePlayerId() {
            return Math.floor(100000 + Math.random() * 900000); // Sinh số 6 chữ số
        }

        // Utility: Sanitize Input to Prevent XSS
        function sanitizeInput(input) {
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML.replace(/</g, '<').replace(/>/g, '>');
        }

        // Default Data
        const defaultUsers = [
            { username: "Người Chơi 1", email: "player1@example.com", password: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", playerId: 123456, balance: 0 }
        ];
        const defaultPlans = {
            trumbox: { price: 3000, description: "Chơi không giới hạn game. Hỗ trợ trên mọi thiết bị. Băng thông ổn định, độ trễ thấp." },
            premium: { price: 350000, description: "Truy cập toàn bộ game. Hỗ trợ độ phân giải 4K. Máy chủ VIP." }
        };
        const defaultCodes = [
            // 15.000 VNĐ Codes (Reward: 15.000 VNĐ)
            { code: "CODE15K01", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K02", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K03", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K04", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K05", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K06", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K07", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K08", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K09", uses: 0, maxUses: 1, reward: 15000 },
            { code: "CODE15K10", uses: 0, maxUses: 1, reward: 15000 },
            // 50.000 VNĐ Codes (Reward: 5.000 VNĐ)
            { code: "CODE50K01", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K02", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K03", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K04", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K05", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K06", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K07", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K08", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K09", uses: 0, maxUses: 1, reward: 5000 },
            { code: "CODE50K10", uses: 0, maxUses: 1, reward: 5000 },
            // 100.000 VNĐ Codes (Reward: 100.000 VNĐ)
            { code: "CODE100K01", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K02", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K03", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K04", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K05", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K06", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K07", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K08", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K09", uses: 0, maxUses: 1, reward: 100000 },
            { code: "CODE100K10", uses: 0, maxUses: 1, reward: 100000 },
            // 200.000 VNĐ Codes (Reward: 200.000 VNĐ)
            { code: "CODE200K01", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K02", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K03", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K04", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K05", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K06", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K07", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K08", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K09", uses: 0, maxUses: 1, reward: 200000 },
            { code: "CODE200K10", uses: 0, maxUses: 1, reward: 200000 },
            // 500.000 VNĐ Codes (Reward: 500.000 VNĐ)
            { code: "CODE500K01", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K02", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K03", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K04", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K05", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K06", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K07", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K08", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K09", uses: 0, maxUses: 1, reward: 500000 },
            { code: "CODE500K10", uses: 0, maxUses: 1, reward: 500000 }
        ];

        // Global State
        let users = JSON.parse(localStorage.getItem('users')) || defaultUsers;
        let plans = JSON.parse(localStorage.getItem('plans')) || defaultPlans;
        let codes = JSON.parse(localStorage.getItem('codes')) || defaultCodes;
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let isLoggedIn = false;
        let userData = { username: "", email: "", playerId: 0, balance: 0 };

        // DOM Elements
        const authLinks = document.getElementById('authLinks');
        const userInfo = document.getElementById('userInfo');
        const userDetails = document.getElementById('userDetails');
        const balanceDisplay = document.querySelector('.balance');
        const logoutButton = document.getElementById('logoutButton');
        const notificationArea = document.getElementById('notificationArea');
        const trumboxPlan = document.getElementById('trumboxPlan');
        const premiumPlan = document.getElementById('premiumPlan');

        // Lock Mechanism with Timeout
        function acquireLock() {
            const lockKey = 'dataLock';
            const lockTimeout = 10000; // 10 seconds
            const currentLock = localStorage.getItem(lockKey);
            const now = Date.now();
            if (currentLock && now - parseInt(currentLock) < lockTimeout) {
                return false;
            }
            localStorage.setItem(lockKey, now.toString());
            return true;
        }

        function releaseLock() {
            localStorage.removeItem('dataLock');
        }

        // Show Loading Spinner
        function showSpinner(spinnerId) {
            const spinner = document.getElementById(spinnerId);
            if (spinner) spinner.style.display = 'block';
        }

        // Hide Loading Spinner
        function hideSpinner(spinnerId) {
            const spinner = document.getElementById(spinnerId);
            if (spinner) spinner.style.display = 'none';
        }

        // Save Data to LocalStorage
        function saveData() {
            try {
                if (!acquireLock()) {
                    throw new Error('Dữ liệu đang được chỉnh sửa bởi thiết bị khác, vui lòng thử lại.');
                }
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('plans', JSON.stringify(plans));
                localStorage.setItem('codes', JSON.stringify(codes));
                localStorage.setItem('notifications', JSON.stringify(notifications));
                localStorage.setItem('transactions', JSON.stringify(transactions));
                localStorage.setItem('userData', JSON.stringify(userData));
                localStorage.setItem('isLoggedIn', isLoggedIn.toString());
                releaseLock();
            } catch (error) {
                console.error('Lỗi khi lưu dữ liệu:', error);
                alert('Có lỗi khi lưu dữ liệu, vui lòng thử lại.');
                releaseLock();
                throw error;
            }
        }

        // Load Data from LocalStorage
        function loadData() {
            try {
                users = JSON.parse(localStorage.getItem('users')) || defaultUsers;
                plans = JSON.parse(localStorage.getItem('plans')) || defaultPlans;
                codes = JSON.parse(localStorage.getItem('codes')) || defaultCodes;
                notifications = JSON.parse(localStorage.getItem('notifications')) || [];
                transactions = JSON.parse(localStorage.getItem('transactions')) || [];
                return { users, plans, codes, notifications, transactions };
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                users = defaultUsers;
                plans = defaultPlans;
                codes = defaultCodes;
                notifications = [];
                transactions = [];
                alert('Có lỗi khi tải dữ liệu, sử dụng dữ liệu mặc định.');
                return { users, plans, codes, notifications, transactions };
            }
        }

        // Update UI Based on Login State
        function updateUserInterface() {
            if (!authLinks || !userInfo || !userDetails || !balanceDisplay) {
                console.error('Thiếu các phần tử DOM trong updateUserInterface.');
                return;
            }
            if (isLoggedIn && userData.playerId) {
                authLinks.style.display = 'none';
                userInfo.style.display = 'flex';
                userDetails.textContent = `${sanitizeInput(userData.username)} (${userData.playerId})`;
                balanceDisplay.textContent = `Số dư: ${userData.balance.toLocaleString('vi-VN')} VNĐ`;
            } else {
                authLinks.style.display = 'flex';
                userInfo.style.display = 'none';
                userDetails.textContent = '';
                balanceDisplay.textContent = 'Số dư: 0 VNĐ';
            }
            updatePlansUI();
            loadNotifications();
        }

        // Update Plans UI
        function updatePlansUI() {
            if (!trumboxPlan || !premiumPlan) {
                console.warn('Không tìm thấy trumboxPlan hoặc premiumPlan.');
                return;
            }
            trumboxPlan.querySelector('.price').textContent = `${plans.trumbox.price.toLocaleString('vi-VN')} VNĐ/giờ`;
            const trumboxDesc = trumboxPlan.querySelectorAll('p:not(.price):not(.subscribers)');
            const trumboxDescLines = plans.trumbox.description.split('. ').filter(d => d);
            trumboxDesc.forEach((p, i) => p.textContent = trumboxDescLines[i] || '');

            premiumPlan.querySelector('.price').textContent = `${plans.premium.price.toLocaleString('vi-VN')} VNĐ/Vĩnh Viễn`;
            const premiumDesc = premiumPlan.querySelectorAll('p:not(.price):not(.subscribers)');
            const premiumDescLines = plans.premium.description.split('. ').filter(d => d);
            premiumDesc.forEach((p, i) => p.textContent = premiumDescLines[i] || '');
        }

        // Redeem Code
        function redeemCode() {
            if (!isLoggedIn) {
                alert('Vui lòng đăng nhập để nhập code!');
                return;
            }
            const redeemCodeInput = document.getElementById('redeemCode');
            const codeSuccess = document.getElementById('codeSuccess');
            const codeError = document.getElementById('codeError');
            const codeSpinner = document.getElementById('codeSpinner');
            const redeemButton = document.querySelector('#code button');
            if (!redeemCodeInput || !codeSuccess || !codeError || !codeSpinner || !redeemButton) {
                console.error('Thiếu các phần tử DOM trong redeemCode.');
                return;
            }
            const code = redeemCodeInput.value.trim().toUpperCase();
            if (!code) {
                codeError.textContent = 'Vui lòng nhập mã code!';
                codeError.style.display = 'block';
                codeSuccess.style.display = 'none';
                codeSpinner.style.display = 'none';
                setTimeout(() => codeError.style.display = 'none', 3000);
                return;
            }
            showSpinner('codeSpinner');
            redeemButton.disabled = true;
            redeemButton.textContent = 'Đang xử lý...';
            setTimeout(() => {
                try {
                    loadData();
                    const codeObj = codes.find(c => c.code === code);
                    if (!codeObj) {
                        codeError.textContent = 'Mã code không hợp lệ!';
                        codeError.style.display = 'block';
                        codeSuccess.style.display = 'none';
                        setTimeout(() => codeError.style.display = 'none', 3000);
                        hideSpinner('codeSpinner');
                        redeemButton.disabled = false;
                        redeemButton.textContent = 'Nhập Code';
                        return;
                    }
                    if (codeObj.uses >= codeObj.maxUses) {
                        codeError.textContent = 'Mã code đã được sử dụng!';
                        codeError.style.display = 'block';
                        codeSuccess.style.display = 'none';
                        setTimeout(() => codeError.style.display = 'none', 3000);
                        hideSpinner('codeSpinner');
                        redeemButton.disabled = false;
                        redeemButton.textContent = 'Nhập Code';
                        return;
                    }
                    const balanceReward = codeObj.reward;
                    userData.balance += balanceReward;
                    const userIndex = users.findIndex(u => u.playerId === userData.playerId);
                    if (userIndex !== -1) {
                        users[userIndex].balance = userData.balance;
                    }
                    codeObj.uses += 1;
                    if (codeObj.uses >= codeObj.maxUses) {
                        codes = codes.filter(c => c.code !== code);
                    }
                    saveData();
                    logTransaction(userData.playerId, 'Redeem Code', balanceReward);
                    codeSuccess.textContent = `Nhập code thành công! Bạn nhận được ${balanceReward.toLocaleString('vi-VN')} VNĐ.`;
                    codeSuccess.style.display = 'block';
                    codeError.style.display = 'none';
                    redeemCodeInput.value = '';
                    updateUserInterface();
                    setTimeout(() => codeSuccess.style.display = 'none', 3000);
                } catch (error) {
                    console.error('Lỗi khi nhập code:', error);
                    codeError.textContent = 'Có lỗi xảy ra, vui lòng thử lại.';
                    codeError.style.display = 'block';
                    codeSuccess.style.display = 'none';
                    setTimeout(() => codeError.style.display = 'none', 3000);
                } finally {
                    hideSpinner('codeSpinner');
                    redeemButton.disabled = false;
                    redeemButton.textContent = 'Nhập Code';
                }
            }, 1000); // Simulate processing delay
        }

        // Load Notifications
        function loadNotifications() {
            if (!notificationArea) {
                console.error('Không tìm thấy notificationArea.');
                return;
            }
            try {
                loadData();
                notificationArea.innerHTML = '';
                notifications.forEach(notification => {
                    const div = document.createElement('div');
                    div.className = 'notification';
                    div.textContent = `${sanitizeInput(notification.message)} (${new Date(notification.timestamp).toLocaleString('vi-VN')})`;
                    notificationArea.appendChild(div);
                });
            } catch (error) {
                console.error('Lỗi khi tải thông báo:', error);
            }
        }

        // Log Transaction
        function logTransaction(userId, type, amount) {
            try {
                loadData();
                transactions.push({
                    userId,
                    type,
                    amount,
                    timestamp: new Date().toISOString()
                });
                saveData();
            } catch (error) {
                console.error('Lỗi khi ghi giao dịch:', error);
            }
        }

        // Rent Trumbox Machine
        function rentTrumbox(event) {
            if (!isLoggedIn) {
                alert('Vui lòng đăng nhập trước khi thuê máy!');
                return;
            }
            showSpinner('trumboxSpinner');
            const button = event?.target;
            if (button) {
                button.disabled = true;
                button.textContent = 'Đang xử lý...';
            }
            try {
                loadData();
                if (userData.balance < plans.trumbox.price) {
                    alert(`Số dư không đủ (cần ít nhất ${plans.trumbox.price.toLocaleString('vi-VN')} VNĐ)!`);
                    if (button) {
                        button.disabled = false;
                        button.textContent = 'Thuê Ngay';
                    }
                    hideSpinner('trumboxSpinner');
                    return;
                }
                userData.balance -= plans.trumbox.price;
                const userIndex = users.findIndex(u => u.playerId === userData.playerId);
                if (userIndex !== -1) {
                    users[userIndex].balance = userData.balance;
                } else {
                    throw new Error('Không tìm thấy người dùng trong danh sách.');
                }
                saveData();
                logTransaction(userData.playerId, 'Rent Trumbox', -plans.trumbox.price);
                alert('Thuê máy thành công! Đang chuyển đến Trumbox...');
                window.open('https://trumbox.net/cloud-gaming/play/', '_blank');
            } catch (error) {
                console.error('Lỗi khi thuê máy:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại.');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Thuê Ngay';
                }
                hideSpinner('trumboxSpinner');
            }
            updateUserInterface();
        }

        // Purchase Plan
        function purchasePlan(planName, price, event) {
            if (!isLoggedIn) {
                alert('Vui lòng đăng nhập trước khi mua gói!');
                return;
            }
            if (userData.balance < price) {
                alert(`Số dư không đủ để mua gói này! Cần ít nhất ${price.toLocaleString('vi-VN')} VNĐ.`);
                return;
            }
            showSpinner('premiumSpinner');
            const button = event?.target;
            if (button) {
                button.disabled = true;
                button.textContent = 'Đang xử lý...';
            }
            try {
                loadData();
                userData.balance -= price;
                const userIndex = users.findIndex(u => u.playerId === userData.playerId);
                if (userIndex !== -1) {
                    users[userIndex].balance = userData.balance;
                } else {
                    throw new Error('Không tìm thấy người dùng trong danh sách.');
                }
                saveData();
                logTransaction(userData.playerId, `Purchase ${planName}`, -price);
                alert(`Đã mua ${planName} thành công!`);
            } catch (error) {
                console.error('Lỗi khi mua gói:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại.');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Mua Gói';
                }
                hideSpinner('premiumSpinner');
            }
            updateUserInterface();
        }

        // Logout
        function logout() {
            try {
                isLoggedIn = false;
                userData = { username: "", email: "", playerId: 0, balance: 0 };
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userData');
                updateUserInterface();
            } catch (error) {
                console.error('Lỗi khi đăng xuất:', error);
                alert('Có lỗi khi đăng xuất, vui lòng thử lại.');
            }
        }

        // Initialize
        function initialize() {
            try {
                loadData();
                isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
                userData = JSON.parse(localStorage.getItem('userData')) || { username: "", email: "", playerId: 0, balance: 0 };
                updateUserInterface();
            } catch (error) {
                console.error('Lỗi khi khởi tạo:', error);
                alert('Có lỗi khi khởi tạo ứng dụng, vui lòng thử lại.');
            }
        }

        initialize();

        // Event Listeners
        if (logoutButton) {
            logoutButton.addEventListener('click', logout);
        }

        // Topup Modal
        const topupModal = document.getElementById('topupModal');
        const topupLink = document.getElementById('topupLink');
        const closeTopupModal = document.getElementById('closeTopupModal');
        const topupForm = document.getElementById('topupForm');
        const topupSpinner = document.getElementById('topupSpinner');
        const topupSuccess = document.getElementById('topupSuccess');
        const topupError = document.getElementById('topupError');
        const paymentMethodSelect = document.getElementById('paymentMethod');

        function toggleForm() {
            const paymentMethod = paymentMethodSelect?.value;
            const bankForm = document.getElementById('bankForm');
            const cardForm = document.getElementById('cardForm');
            if (bankForm && cardForm) {
                bankForm.style.display = paymentMethod === 'bank' ? 'block' : 'none';
                cardForm.style.display = paymentMethod === 'card' ? 'block' : 'none';
            }
        }

        if (topupLink) {
            topupLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (topupModal && topupSuccess && topupError && topupForm) {
                    topupModal.style.display = 'flex';
                    topupSuccess.style.display = 'none';
                    topupError.style.display = 'none';
                    topupForm.reset();
                    toggleForm();
                }
            });
        }

        if (closeTopupModal) {
            closeTopupModal.addEventListener('click', () => {
                if (topupModal) topupModal.style.display = 'none';
            });
        }

        if (topupForm) {
            topupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!isLoggedIn) {
                    if (topupError) {
                        topupError.textContent = 'Vui lòng đăng nhập trước khi nạp tiền!';
                        topupError.style.display = 'block';
                        if (topupSuccess) topupSuccess.style.display = 'none';
                        setTimeout(() => topupError.style.display = 'none', 3000);
                    }
                    return;
                }
                showSpinner('topupSpinner');
                try {
                    if (topupSuccess && topupError) {
                        topupSuccess.style.display = 'block';
                        topupError.style.display = 'none';
                    }
                    topupForm.reset();
                    toggleForm();
                    setTimeout(() => {
                        if (topupModal) topupModal.style.display = 'none';
                        if (topupSuccess) topupSuccess.style.display = 'none';
                    }, 2000);
                } catch (error) {
                    console.error('Lỗi khi gửi yêu cầu nạp tiền:', error);
                    if (topupError) {
                        topupError.textContent = 'Có lỗi xảy ra, vui lòng thử lại.';
                        topupError.style.display = 'block';
                        if (topupSuccess) topupSuccess.style.display = 'none';
                        setTimeout(() => topupError.style.display = 'none', 3000);
                    }
                } finally {
                    hideSpinner('topupSpinner');
                }
            });
        }

        // Login Modal
        const loginModal = document.getElementById('loginModal');
        const loginLink = document.getElementById('loginLink');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');

        if (loginLink) {
            loginLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (loginModal && topupModal && registerModal && loginError && loginForm) {
                    loginModal.style.display = 'flex';
                    topupModal.style.display = 'none';
                    registerModal.style.display = 'none';
                    loginError.style.display = 'none';
                    loginForm.reset();
                }
            });
        }

        if (closeLoginModal) {
            closeLoginModal.addEventListener('click', () => {
                if (loginModal) loginModal.style.display = 'none';
            });
        }

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showSpinner('loginSpinner');
                const loginEmail = document.getElementById('loginEmail');
                const loginPassword = document.getElementById('loginPassword');
                if (!loginEmail || !loginPassword) {
                    console.error('Thiếu loginEmail hoặc loginPassword.');
                    hideSpinner('loginSpinner');
                    return;
                }
                const email = loginEmail.value.trim();
                const password = loginPassword.value.trim();
                if (!email || !password) {
                    if (loginError) {
                        loginError.textContent = 'Vui lòng nhập email và mật khẩu!';
                        loginError.style.display = 'block';
                        setTimeout(() => loginError.style.display = 'none', 3000);
                    }
                    hideSpinner('loginSpinner');
                    return;
                }
                try {
                    loadData();
                    const hashedPassword = await hashPassword(password);
                    const user = users.find(u => u.email === email && u.password === hashedPassword);
                    if (!user) {
                        if (loginError) {
                            loginError.textContent = 'Email hoặc mật khẩu không đúng!';
                            loginError.style.display = 'block';
                            setTimeout(() => loginError.style.display = 'none', 3000);
                        }
                        hideSpinner('loginSpinner');
                        return;
                    }
                    isLoggedIn = true;
                    userData = { username: user.username, email: user.email, playerId: user.playerId, balance: user.balance };
                    saveData();
                    updateUserInterface();
                    if (loginModal) loginModal.style.display = 'none';
                    loginForm.reset();
                } catch (error) {
                    console.error('Lỗi khi đăng nhập:', error);
                    if (loginError) {
                        loginError.textContent = 'Có lỗi xảy ra, vui lòng thử lại.';
                        loginError.style.display = 'block';
                        setTimeout(() => loginError.style.display = 'none', 3000);
                    }
                } finally {
                    hideSpinner('loginSpinner');
                }
            });
        }

        // Register Modal
        const registerModal = document.getElementById('registerModal');
        const registerLink = document.getElementById('registerLink');
        const closeRegisterModal = document.getElementById('closeRegisterModal');
        const registerForm = document.getElementById('registerForm');
        const registerError = document.getElementById('registerError');
        const registerSuccess = document.getElementById('registerSuccess');
        const showLogin = document.getElementById('showLogin');
        const showRegister = document.getElementById('showRegister');

        if (registerLink) {
            registerLink.addEventListener('click', (e) => {
                e.preventDefault();
                if (registerModal && topupModal && loginModal && registerError && registerSuccess && registerForm) {
                    registerModal.style.display = 'flex';
                    topupModal.style.display = 'none';
                    loginModal.style.display = 'none';
                    registerError.style.display = 'none';
                    registerSuccess.style.display = 'none';
                    registerForm.reset();
                }
            });
        }

        if (closeRegisterModal) {
            closeRegisterModal.addEventListener('click', () => {
                if (registerModal) registerModal.style.display = 'none';
            });
        }

        if (showLogin) {
            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                if (loginModal && registerModal) {
                    loginModal.style.display = 'flex';
                    registerModal.style.display = 'none';
                }
            });
        }

        if (showRegister) {
            showRegister.addEventListener('click', (e) => {
                e.preventDefault();
                if (registerModal && loginModal) {
                    registerModal.style.display = 'flex';
                    loginModal.style.display = 'none';
                }
            });
        }

        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showSpinner('registerSpinner');
                const registerUsername = document.getElementById('registerUsername');
                const registerEmail = document.getElementById('registerEmail');
                const registerPassword = document.getElementById('registerPassword');
                const confirmPassword = document.getElementById('confirmPassword');
                if (!registerUsername || !registerEmail || !registerPassword || !confirmPassword) {
                    console.error('Thiếu các phần tử trong registerForm.');
                    hideSpinner('registerSpinner');
                    return;
                }
                const username = sanitizeInput(registerUsername.value.trim());
                const email = registerEmail.value.trim();
                const password = registerPassword.value;
                const confirmPasswordValue = confirmPassword.value;
                let errorMessage = '';
                if (username.length < 3) {
                    errorMessage = 'Tên người dùng phải có ít nhất 3 ký tự.';
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    errorMessage = 'Email không hợp lệ.';
                } else if (password.length < 6 || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
                    errorMessage = 'Mật khẩu phải có ít nhất 6 ký tự, bao gồm chữ hoa và số.';
                } else if (password !== confirmPasswordValue) {
                    errorMessage = 'Mật khẩu xác nhận không khớp.';
                } else if (users.some(u => u.email === email)) {
                    errorMessage = 'Email đã được sử dụng!';
                } else if (users.some(u => u.username === username)) {
                    errorMessage = 'Tên người dùng đã được sử dụng!';
                }
                if (errorMessage) {
                    if (registerError) {
                        registerError.textContent = errorMessage;
                        registerError.style.display = 'block';
                        registerSuccess.style.display = 'none';
                        setTimeout(() => registerError.style.display = 'none', 3000);
                    }
                    hideSpinner('registerSpinner');
                    return;
                }
                try {
                    loadData();
                    const hashedPassword = await hashPassword(password);
                    let playerId;
                    do {
                        playerId = generatePlayerId();
                    } while (users.some(u => u.playerId === playerId));
                    const newUser = {
                        username,
                        email,
                        password: hashedPassword,
                        playerId,
                        balance: 0
                    };
                    users.push(newUser);
                    isLoggedIn = true;
                    userData = { username, email, playerId, balance: 0 };
                    saveData();
                    if (registerSuccess && registerError) {
                        registerSuccess.style.display = 'block';
                        registerError.style.display = 'none';
                    }
                    updateUserInterface();
                    setTimeout(() => {
                        if (registerModal) registerModal.style.display = 'none';
                        if (registerSuccess) registerSuccess.style.display = 'none';
                    }, 2000);
                    registerForm.reset();
                } catch (error) {
                    console.error('Lỗi khi đăng ký:', error);
                    if (registerError) {
                        registerError.textContent = 'Có lỗi xảy ra, vui lòng thử lại.';
                        registerError.style.display = 'block';
                        registerSuccess.style.display = 'none';
                        setTimeout(() => registerError.style.display = 'none', 3000);
                    }
                } finally {
                    hideSpinner('registerSpinner');
                }
            });
        }

        // Hamburger Menu with Outside Click Close
        const hamburger = document.querySelector('.hamburger');
        const menu = document.querySelector('.menu');
        if (hamburger && menu) {
            hamburger.addEventListener('click', () => {
                menu.classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!menu.contains(e.target) && !hamburger.contains(e.target) && menu.classList.contains('active')) {
                    menu.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
